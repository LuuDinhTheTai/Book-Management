<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>BM - Update Book</title>
    <link rel="stylesheet" th:href="@{/style.css}"/>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">
</head>
<body>
<div th:replace="component/navbar :: navbar"></div>

<div class="container">
    <h1 class="page-title">Update Book</h1>

    <div th:if="${errorMessage}" class="error">
        <p th:text="${errorMessage}"></p>
    </div>

    <form th:action="@{|/books/update/${book.id}|}" th:object="${book}" method="post" class="form" enctype="multipart/form-data">
        <label>Name:</label>
        <input name="name" type="text" th:value="${book.name}"/>
        <div th:if="${#fields.hasErrors('name')}" class="error" th:errors="*{name}"></div>
        <br>

        <label>Price:</label>
        <input name="price" type="number" step="0.01" th:value="${book.price}"/>
        <div th:if="${#fields.hasErrors('price')}" class="error" th:errors="*{price}"></div>
        <br>

        <label>Quantity:</label>
        <input name="qty" type="number" th:value="${book.qty}"/>
        <div th:if="${#fields.hasErrors('qty')}" class="error" th:errors="*{qty}"></div>
        <br>

        <label>Status:</label>
        <select name="status">
            <option value="" disabled selected>Choose status</option>
            <option th:each="status : ${statuses}"
                    th:value="${status}"
                    th:text="${status}"
                    th:selected="${book.status == status}">
            </option>
        </select>
        <div th:if="${#fields.hasErrors('status')}" class="error" th:errors="*{status}"></div>
        <br>

        <label>Categories:</label>
        <div class="category-selection">
            <div th:each="category : ${categories}" class="category-checkbox">
                <input type="checkbox"
                       name="categories"
                       th:value="${category.id}"
                       th:id="'category-' + ${category.id}"
                       th:checked="${book.categories.contains(category)}"/>
                <label th:for="'category-' + ${category.id}" th:text="${category.name}"></label>
            </div>
        </div>
        <div th:if="${#fields.hasErrors('categories')}" class="error" th:errors="*{categories}"></div>
        <br>

        <div class="file-upload-section">
            <label>Cover Image:</label>
            <input id="coverImageFile" type="file" accept="image/*"
                   onchange="uploadFile(this, 'coverImageFileId', 'Book Cover')"/>
            <small>Upload a new cover image (will replace existing one)</small>

            <div id="coverImagePreview" class="file-preview" style="display: none;">
                <img id="coverImagePreviewImg" src="" alt="Cover Preview"/>
                <div class="file-info">
                    <span id="coverImageFileName"></span>
                    <span id="coverImageFileSize"></span>
                </div>
            </div>

            <input type="hidden" name="coverImageFileId" id="coverImageFileId"/>
        </div>

        <div class="file-upload-section">
            <label>Book PDF:</label>
            <input name="bookFile" type="file" accept="application/pdf"/>
            <small>Upload a new book PDF (will replace existing one)</small>
        </div>

        <!-- Display current files if exist -->
        <div th:if="${book.files != null}" class="existing-files">
            <h4>Current Files:</h4>
            <div class="files-grid">
                <div th:each="file : ${book.files}" th:if="${file.fileType == 'Book Cover'}" class="file-item">
                    <div class="file-info">
                        <h3 class="file-title">Current Cover Image</h3>
                        <div class="file-preview">
                            <img th:src="${file.fileUrl}" th:alt="${book.name} + ' Cover'" class="cover-preview"/>
                        </div>
                        <div class="file-details">
                            <span class="file-name" th:text="${file.fileName}"></span>
                            <span class="file-size" th:text="${file.fileSize + ' bytes'}"></span>
                        </div>
                    </div>
                </div>

                
                <div th:each="file : ${book.files}" th:if="${file.fileType == 'Book Pdf'}" class="file-item">
                    <div class="file-info">
                        <h3 class="file-title">Current Book PDF</h3>
                        <div class="file-preview">
                            <div class="pdf-preview">ðŸ“„</div>
                        </div>
                        <div class="file-details">
                            <span class="file-name" th:text="${file.fileName}"></span>
                            <span class="file-size" th:text="${file.fileSize + ' bytes'}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br>

        <fieldset>
            <legend>Detail</legend>
            <label>ISBN:</label>
            <input th:field="*{detail.isbn}" type="text"/>
            <div th:if="${#fields.hasErrors('detail.isbn')}" class="error" th:errors="*{detail.isbn}"></div>
            <br>

            <label>Title:</label>
            <input th:field="*{detail.title}" type="text"/>
            <div th:if="${#fields.hasErrors('detail.title')}" class="error" th:errors="*{detail.title}"></div>
            <br>

            <label>Subtitle:</label>
            <input th:field="*{detail.subtitle}" type="text"/>
            <div th:if="${#fields.hasErrors('detail.subtitle')}" class="error" th:errors="*{detail.subtitle}"></div>
            <br>

            <label>Author:</label>
            <input th:field="*{detail.author}" type="text"/>
            <div th:if="${#fields.hasErrors('detail.author')}" class="error" th:errors="*{detail.author}"></div>
            <br>

            <label>Publisher:</label>
            <input th:field="*{detail.publisher}" type="text"/>
            <div th:if="${#fields.hasErrors('detail.publisher')}" class="error" th:errors="*{detail.publisher}"></div>
            <br>

            <label>Published Date:</label>
            <input th:field="*{detail.publishedDate}" type="datetime-local"/>
            <div th:if="${#fields.hasErrors('detail.publishedDate')}" class="error"
                 th:errors="*{detail.publishedDate}"></div>
            <br>

            <label>Description:</label>
            <textarea th:field="*{detail.description}" rows="4" cols="50"></textarea>
            <div th:if="${#fields.hasErrors('detail.description')}" class="error"
                 th:errors="*{detail.description}"></div>
            <br>

            <label>Page Count:</label>
            <input th:field="*{detail.pageCount}" type="text"/>
            <div th:if="${#fields.hasErrors('detail.pageCount')}" class="error" th:errors="*{detail.pageCount}"></div>
            <br>

            <label>Language:</label>
            <select th:field="*{detail.language}">
                <option value="" disabled selected>Choose language</option>
                <option th:each="lang : ${languages}"
                        th:value="${lang}"
                        th:text="${lang}">
                </option>
            </select>
            <div th:if="${#fields.hasErrors('detail.language')}" class="error" th:errors="*{detail.language}"></div>
            <br>

            <label>Format:</label>
            <select th:field="*{detail.format}">
                <option value="" disabled selected>Choose format</option>
                <option th:each="fmt : ${formats}"
                        th:value="${fmt}"
                        th:text="${fmt}">
                </option>
            </select>
            <div th:if="${#fields.hasErrors('detail.format')}" class="error" th:errors="*{detail.format}"></div>
            <br>
        </fieldset>
        <button type="submit">Update</button>
    </form>

</div>
<script>
    async function uploadFile(inputElem, hiddenFieldId, fileType) {
        const file = inputElem.files[0];
        if (!file) return;

        // Show preview immediately
        const previewContainer = document.getElementById(hiddenFieldId.replace('Id', 'Preview'));
        const nameSpan = document.getElementById(hiddenFieldId.replace('Id', 'Name'));
        const sizeSpan = document.getElementById(hiddenFieldId.replace('Id', 'Size'));

        if (previewContainer && nameSpan && sizeSpan) {
            previewContainer.style.display = 'block';
            nameSpan.textContent = file.name;
            sizeSpan.textContent = formatFileSize(file.size);
            if (previewContainer.querySelector('img')) {
                previewContainer.querySelector('img').src = URL.createObjectURL(file);
            }
        }

        // Create form data
        const formData = new FormData();
        formData.append('file', file);
        formData.append('fileType', fileType);

        try {
            // Upload to the correct endpoint
            const response = await fetch('/attachments/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            document.getElementById(hiddenFieldId).value = data.id;

            console.log('File uploaded successfully:', data);

        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload file: ' + error.message);
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
</body>
</html>