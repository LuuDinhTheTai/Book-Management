<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Role - BookStore</title>
    <link rel="stylesheet" th:href="@{/style.css}">
</head>
<body>
<!-- Include Navbar -->
<div th:replace="~{component/navbar :: navbar}"></div>

<div class="container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a th:href="@{/books/list}" class="breadcrumb-link">Home</a>
        <span class="breadcrumb-separator">/</span>
        <a th:href="@{/roles/list}" class="breadcrumb-link">Roles</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Create Role</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">Create New Role</h1>
            <p class="page-subtitle">Add a new role with specific permissions</p>
        </div>
        <div class="header-actions">
            <a th:href="@{/roles/list}" class="btn btn-outline">
                <span class="btn-icon">‚Üê</span>
                Back to Roles
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    <div th:if="${errorMessage}" class="alert alert-error">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <span th:text="${errorMessage}"></span>
    </div>

    <div th:if="${successMessage}" class="alert alert-success">
        <span class="alert-icon">‚úÖ</span>
        <span th:text="${successMessage}"></span>
    </div>

    <!-- Create Role Form -->
    <form th:action="@{/roles/create}" th:object="${createRoleRequest}" method="post" class="auth-form">
        <div class="form-group">
            <label for="name" class="form-label">
                <span class="label-icon">üè∑Ô∏è</span>
                Role Name
            </label>
            <input type="text"
                   id="name"
                   th:field="*{name}"
                   class="form-input"
                   placeholder="Enter role name"
                   required>
            <span th:if="${#fields.hasErrors('name')}" class="form-error" th:errors="*{name}"></span>
        </div>

        <div class="form-group">
            <label for="description" class="form-label">
                <span class="label-icon">üìù</span>
                Description
            </label>
            <textarea id="description"
                      th:field="*{description}"
                      class="form-input"
                      placeholder="Enter role description"
                      rows="3"
                      required></textarea>
            <span th:if="${#fields.hasErrors('description')}" class="form-error" th:errors="*{description}"></span>
        </div>

        <div class="form-group">
            <label class="form-label">
                <span class="label-icon">üîê</span>
                Permissions
            </label>
            <div class="permissions-matrix-container">
                <div>
                    <table>
                        <thead>
                        <tr>
                            <th>

                            </th>
                            <th th:each="action : ${actions}">
                                <span th:text="${action.name}"></span>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="resource : ${resources}">
                            <td>
                                <span th:text="${resource.name}"></span>
                            </td>
                            <div th:each="action : ${actions}">
                                <td>
                                    <input type="checkbox"
                                           th:id="${action.name + resource.name}"
                                           th:name="${action.name + resource.name}"
                                           th:field="*{permissions}"
                                           th:value="${action.id + '-' + resource.id}"
                                    />
                                </td>
                            </div>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <span th:if="${#fields.hasErrors('permissions')}" class="form-error" th:errors="*{permissions}"></span>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-full">
                <span class="btn-icon">‚ûï</span>
                Create Role
            </button>
            <a th:href="@{/roles/list}" class="btn btn-outline btn-full">
                <span class="btn-icon">‚ùå</span>
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // Form validation
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');

        form.addEventListener('submit', function (e) {
            let isValid = true;

            // Validate name
            if (!nameInput.value.trim()) {
                showError(nameInput, 'Role name is required');
                isValid = false;
            } else {
                clearError(nameInput);
            }

            // Validate description
            if (!descriptionInput.value.trim()) {
                showError(descriptionInput, 'Description is required');
                isValid = false;
            } else {
                clearError(descriptionInput);
            }

            // Validate permissions (at least one selected)
            const permissionCheckboxes = document.querySelectorAll('input[name="permissions"]:checked');
            if (permissionCheckboxes.length === 0) {
                const permissionSection = document.querySelector('.permissions-matrix-container');
                showSectionError(permissionSection, 'Please select at least one permission');
                isValid = false;
            } else {
                clearSectionError(permissionSection);
            }

            if (!isValid) {
                e.preventDefault();
            } else {
                // Process permissions before submission
                processPermissions();
            }
        });

        function processPermissions() {
            const checkedPermissions = document.querySelectorAll('input[name="permissions"]:checked');
            const permissions = [];

            checkedPermissions.forEach(checkbox => {
                const value = checkbox.value;
                if (value) {
                    permissions.push(value);
                }
            });

            // Add hidden inputs for permissions
            addHiddenInputs('permissions', permissions);
        }

        function addHiddenInputs(name, values) {
            // Remove existing hidden inputs
            const existingInputs = document.querySelectorAll(`input[name="${name}"]`);
            existingInputs.forEach(input => input.remove());

            // Add new hidden inputs
            values.forEach(value => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = name;
                hiddenInput.value = value;
                form.appendChild(hiddenInput);
            });
        }

        function showError(input, message) {
            clearError(input);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'form-error';
            errorDiv.textContent = message;
            input.parentNode.appendChild(errorDiv);
            input.classList.add('form-input-error');
        }

        function clearError(input) {
            const existingError = input.parentNode.querySelector('.form-error');
            if (existingError) {
                existingError.remove();
            }
            input.classList.remove('form-input-error');
        }

        function showSectionError(section, message) {
            clearSectionError(section);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'form-error';
            errorDiv.textContent = message;
            section.parentNode.appendChild(errorDiv);
        }

        function clearSectionError(section) {
            const existingError = section.parentNode.querySelector('.form-error');
            if (existingError) {
                existingError.remove();
            }
        }
    });
</script>
</body>
</html>